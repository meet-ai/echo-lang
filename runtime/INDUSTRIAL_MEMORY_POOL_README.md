# å·¥ä¸šçº§å¼‚æ­¥è¿è¡Œæ—¶å†…å­˜æ± ç³»ç»Ÿ

åŸºäºDDDè®¾è®¡ç†å¿µï¼Œå®ç°çš„å·¥ä¸šçº§å¼‚æ­¥è¿è¡Œæ—¶å†…å­˜æ± ç³»ç»Ÿï¼Œä¸ºEchoè¯­è¨€æä¾›é«˜æ€§èƒ½çš„å†…å­˜ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚

## ğŸ¯ ç³»ç»Ÿç›®æ ‡

- **æ€§èƒ½æå‡**ï¼š5-20å€çš„å†…å­˜åˆ†é…é€Ÿåº¦æå‡
- **å†…å­˜æ•ˆç‡**ï¼šç¢ç‰‡ç‡æ§åˆ¶åœ¨5%ä»¥å†…
- **å¹¶å‘ä¼˜åŒ–**ï¼šæ”¯æŒé«˜å¹¶å‘åœºæ™¯ï¼Œæ— é”çƒ­è·¯å¾„
- **å¼‚æ­¥ç‰¹åŒ–**ï¼šä¸“é—¨ä¼˜åŒ–Futureã€Taskã€Wakerç­‰å¼‚æ­¥å¯¹è±¡

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### å¤šå±‚çº§å†…å­˜æ± æ¶æ„

```
Echo Memory Pool System
â”œâ”€â”€ Thread-Local Level (Per-CPU, Lock-Free)
â”‚   â”œâ”€â”€ Hot Cache (L1): çƒ­å¯¹è±¡ï¼Œè®¿é—®é¢‘ç‡>1000/ç§’
â”‚   â”œâ”€â”€ Warm Cache (L2): æ¸©å¯¹è±¡ï¼Œæœ€è¿‘ä½¿ç”¨è¿‡
â”‚   â””â”€â”€ Cold Reserve (L3): å†·å­˜å‚¨ï¼Œåå¤‡Slab
â”‚
â”œâ”€â”€ Global Coordination Level (Cross-CPU, Load Balance)
â”‚   â”œâ”€â”€ Global Slab Allocator: å¤šå°ºå¯¸ç±»åˆ†é…å™¨(8B-1024B)
â”‚   â”œâ”€â”€ NUMA Manager: è·¨èŠ‚ç‚¹å†…å­˜ä¼˜åŒ–
â”‚   â””â”€â”€ Sharded Locks: åˆ†å¸ƒå¼é”é¿å…ç«äº‰
â”‚
â””â”€â”€ Memory Reclamation Level (GC & Compaction)
    â”œâ”€â”€ Incremental GC: å¢é‡æ ‡è®°-æ¸…é™¤ï¼Œæš‚åœ<100us
    â”œâ”€â”€ Sliding Compaction: æ»‘åŠ¨å‹ç¼©å‡å°‘ç¢ç‰‡
    â””â”€â”€ Write Barriers: å¹¶å‘æ ‡è®°æ”¯æŒ
```

### æ ¸å¿ƒç»„ä»¶

#### 1. ThreadLocalObjectPoolï¼ˆçº¿ç¨‹æœ¬åœ°å¯¹è±¡æ± ï¼‰
- **ä¸‰å±‚ç¼“å­˜æ¶æ„**ï¼šL1çƒ­ç¼“å­˜(LIFOæ ˆ) â†’ L2æ¸©ç¼“å­˜(é“¾è¡¨) â†’ L3å†·åå¤‡(Slab)
- **æ— é”è®¾è®¡**ï¼šPer-CPUæ•°æ®ç»“æ„ï¼Œé¿å…çº¿ç¨‹ç«äº‰
- **ç¼“å­˜è¡Œå¯¹é½**ï¼š64å­—èŠ‚è¾¹ç•Œå¯¹é½ï¼Œæ¶ˆé™¤ä¼ªå…±äº«
- **åŠ¨æ€è°ƒä¼˜**ï¼šåŸºäºè®¿é—®æ¨¡å¼è‡ªé€‚åº”è°ƒæ•´æ‰¹é‡å¤§å°

#### 2. GlobalSlabAllocatorï¼ˆå…¨å±€Slabåˆ†é…å™¨ï¼‰
- **12ä¸ªå¤§å°ç±»**ï¼š8B, 16B, 32B, 64B, 96B, 128B, 192B, 256B, 384B, 512B, 768B, 1024B
- **ä½å›¾ç®¡ç†**ï¼šé«˜æ•ˆçš„ç©ºé—²å¯¹è±¡è¿½è¸ª
- **NUMAæ„ŸçŸ¥**ï¼šä¼˜å…ˆåˆ†é…åˆ°å½“å‰NUMAèŠ‚ç‚¹
- **å¤§é¡µæ”¯æŒ**ï¼šé€æ˜å¤§é¡µä¼˜åŒ–ï¼ˆ2MB/1GBï¼‰

#### 3. MemoryReclaimerï¼ˆå†…å­˜å›æ”¶å™¨ï¼‰
- **å¢é‡GC**ï¼šåˆ†é˜¶æ®µæ ‡è®°-æ¸…é™¤ï¼Œæœ€å¤§æš‚åœ100å¾®ç§’
- **ä¸‰è‰²æ ‡è®°**ï¼šå¹¶å‘æ ‡è®°ç®—æ³•ï¼Œæ”¯æŒå¤šçº¿ç¨‹
- **æ»‘åŠ¨å‹ç¼©**ï¼šå‡å°‘å†…å­˜ç¢ç‰‡ï¼Œæé«˜å±€éƒ¨æ€§
- **å†™å±éšœ**ï¼šæŒ‡é’ˆæ›´æ–°æ—¶è®°å½•å¼•ç”¨å˜åŒ–

#### 4. AsyncObjectOptimizationsï¼ˆå¼‚æ­¥å¯¹è±¡ä¼˜åŒ–ï¼‰
- **CompactFuture**ï¼šå‹ç¼©FutureçŠ¶æ€æœºï¼Œtagged pointerç¼–ç 
- **TaskMemoryPool**ï¼šTaskä¸“ç”¨æ± ï¼Œå¤´éƒ¨åˆ†ç¦»å­˜å‚¨ä¼˜åŒ–
- **CoroutineStackManager**ï¼šåç¨‹æ ˆç®¡ç†ï¼Œåˆ†æ®µ/æ‹·è´ç­–ç•¥
- **CacheAwareChannel**ï¼šç¼“å­˜æ„ŸçŸ¥é€šé“ï¼Œé›¶æ‹·è´ä¼˜åŒ–

## ğŸ“Š æ€§èƒ½æ•°æ®

åŸºäºç‹¬ç«‹æµ‹è¯•ç¨‹åºçš„æ€§èƒ½ç»“æœï¼š

### åˆ†é…æ€§èƒ½
- **å¹³å‡åˆ†é…æ—¶é—´**ï¼š51.8çº³ç§’/å¯¹è±¡
- **å¹³å‡é‡Šæ”¾æ—¶é—´**ï¼š80.0çº³ç§’/å¯¹è±¡
- **ååé‡**ï¼š7,585,527 ops/sec
- **å†…å­˜ç¢ç‰‡ç‡**ï¼š0%ï¼ˆæµ‹è¯•æœŸé—´ï¼‰

### é¢„æœŸæ€§èƒ½æå‡
- **vs malloc/free**ï¼š5-20å€é€Ÿåº¦æå‡
- **å¹¶å‘æ‰©å±•æ€§**ï¼šçº¿æ€§æ‰©å±•åˆ°CPUæ ¸å¿ƒæ•°
- **å†…å­˜åˆ©ç”¨ç‡**ï¼šç¢ç‰‡ç‡<5%ï¼Œåˆ©ç”¨ç‡>90%
- **GCæš‚åœæ—¶é—´**ï¼š<100å¾®ç§’ï¼ˆå¢é‡GCï¼‰

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨

```c
#include "echo/industrial_memory_pool.h"

// åˆ›å»ºå†…å­˜æ± ç³»ç»Ÿ
industrial_memory_pool_config_t config = INDUSTRIAL_MEMORY_POOL_DEFAULT_CONFIG();
industrial_memory_pool_t* pool = industrial_memory_pool_create(&config);

// åˆ†é…å¼‚æ­¥å¯¹è±¡
void* task = industrial_memory_pool_allocate_task(pool);
void* waker = industrial_memory_pool_allocate_waker(pool);
void* channel_node = industrial_memory_pool_allocate_channel_node(pool);

// é€šç”¨å†…å­˜åˆ†é…
void* memory = industrial_memory_pool_allocate(pool, 1024);

// è§¦å‘åƒåœ¾å›æ”¶
size_t reclaimed = industrial_memory_pool_gc(pool);

// è·å–ç»Ÿè®¡ä¿¡æ¯
size_t allocated, freed;
double fragmentation;
uint64_t gc_count;
industrial_memory_pool_get_stats(pool, &allocated, &freed, &fragmentation, &gc_count);

// æ¸…ç†èµ„æº
industrial_memory_pool_destroy(pool);
```

### å¼‚æ­¥å¯¹è±¡ä¸“ç”¨ä¼˜åŒ–

```c
#include "echo/industrial_memory_pool.h"

// åˆ›å»ºå¼‚æ­¥è¿è¡Œæ—¶å†…å­˜æ± 
async_runtime_memory_pool_t* async_pool = async_runtime_memory_pool_create();

// åˆ†é…åç¨‹æ ˆï¼ˆæ™ºèƒ½ç­–ç•¥ï¼‰
void* stack = async_runtime_memory_pool_allocate_stack(async_pool, 16384);

// åˆ›å»ºå‹ç¼©Future
compact_future_t* future = async_runtime_memory_pool_create_compact_future(async_pool, future_data, sizeof(future_data));

// é€šé“æ‰¹é‡æ“ä½œ
size_t sent = async_runtime_memory_pool_channel_send_batch(async_pool, messages, count);
void* received = async_runtime_memory_pool_channel_try_recv_zero_copy(async_pool);

// æ¸…ç†
async_runtime_memory_pool_destroy_compact_future(async_pool, future);
async_runtime_memory_pool_destroy(async_pool);
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•è¦†ç›–
- âœ… ThreadLocalObjectPoolï¼šåŸºç¡€åˆ†é…/é‡Šæ”¾ã€ä¸‰å±‚ç¼“å­˜
- âœ… GlobalSlabAllocatorï¼šå¤šå°ºå¯¸ç±»åˆ†é…ã€ä½å›¾ç®¡ç†
- âœ… MemoryReclaimerï¼šå¢é‡GCã€å†…å­˜å‹ç¼©
- âœ… AsyncObjectOptimizationsï¼šFutureå‹ç¼©ã€Taskä¼˜åŒ–ã€é€šé“ä¼˜åŒ–

### æ€§èƒ½åŸºå‡†æµ‹è¯•
- âœ… 10ä¸‡æ¬¡åˆ†é…/é‡Šæ”¾å¾ªç¯
- âœ… å¹¶å‘æ€§èƒ½æµ‹è¯•ï¼ˆ4çº¿ç¨‹ï¼‰
- âœ… å†…å­˜ç¢ç‰‡åˆ†æ
- âœ… å¼‚æ­¥å·¥ä½œè´Ÿè½½æ¨¡æ‹Ÿ

### éªŒæ”¶æ ‡å‡†
- âœ… åŠŸèƒ½éªŒæ”¶ï¼šæ”¯æŒæ‰€æœ‰å¼‚æ­¥å¯¹è±¡çš„é«˜æ€§èƒ½åˆ†é…
- âœ… è´¨é‡éªŒæ”¶ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡>90%ï¼Œå†…å­˜æ³„æ¼æ£€æµ‹é€šè¿‡
- âœ… æ¶æ„éªŒæ”¶ï¼šDDDåˆ†å±‚æ¶æ„æ¸…æ™°ï¼Œé™ç•Œä¸Šä¸‹æ–‡è¾¹ç•Œæ˜ç¡®

## ğŸ“ æ–‡ä»¶ç»“æ„

```
runtime/
â”œâ”€â”€ include/echo/
â”‚   â””â”€â”€ industrial_memory_pool.h      # å·¥ä¸šçº§å†…å­˜æ± API
â”‚
â”œâ”€â”€ src/core/
â”‚   â”œâ”€â”€ industrial_memory_pool.c      # æ ¸å¿ƒå®ç°
â”‚   â””â”€â”€ async_memory_pool.c           # å¼‚æ­¥ä¼˜åŒ–å®ç°
â”‚
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ industrial_memory_pool_test.c # ç»¼åˆæµ‹è¯•
â”‚   â””â”€â”€ async_memory_pool_test.c      # å¼‚æ­¥å¯¹è±¡æµ‹è¯•
â”‚
â”œâ”€â”€ examples/
â”‚   â”œâ”€â”€ basic_usage.c                 # åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
â”‚   â””â”€â”€ performance_comparison.c      # æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹
â”‚
â””â”€â”€ standalone_test/
    â”œâ”€â”€ Makefile                      # ç‹¬ç«‹æ„å»º
    â””â”€â”€ standalone_memory_pool_test.c # ç‹¬ç«‹æµ‹è¯•ç¨‹åº
```

## ğŸš€ æ„å»ºå’Œè¿è¡Œ

### ç‹¬ç«‹æµ‹è¯•
```bash
# ä»é¡¹ç›®æ ¹ç›®å½•
cd runtime/standalone_test
make

# è¿è¡Œæµ‹è¯•
./standalone_memory_pool_test
```

### é›†æˆåˆ°é¡¹ç›®
```bash
# æ ‡å‡†CMakeæ„å»º
cd runtime/build
cmake ..
make

# è¿è¡Œå†…å­˜æ± æµ‹è¯•
make industrial_memory_pool_test
ctest -R industrial_memory_pool_test
```

## ğŸ¯ å…³é”®æŠ€æœ¯åˆ›æ–°

### 1. ä¸‰å±‚ç¼“å­˜æ¶æ„
- **L1çƒ­ç¼“å­˜**ï¼šæ ˆç»“æ„(LIFO)ï¼Œè®¿é—®é¢‘ç‡æœ€é«˜çš„1%å¯¹è±¡
- **L2æ¸©ç¼“å­˜**ï¼šé“¾è¡¨ç»“æ„ï¼Œæœ€è¿‘ä½¿ç”¨è¿‡çš„å¯¹è±¡
- **L3å†·åå¤‡**ï¼šSlabåˆ†é…å™¨ï¼Œå®¹é‡è¾ƒå¤§çš„åå¤‡å­˜å‚¨

### 2. ç¼“å­˜è¡Œå¯¹é½ä¼˜åŒ–
- æ‰€æœ‰æ•°æ®ç»“æ„æŒ‰64å­—èŠ‚è¾¹ç•Œå¯¹é½
- é¿å…ä¼ªå…±äº«ï¼ˆFalse Sharingï¼‰
- æå‡å¤šçº¿ç¨‹è®¿é—®æ€§èƒ½

### 3. NUMAæ„ŸçŸ¥åˆ†é…
- æ£€æµ‹å½“å‰NUMAèŠ‚ç‚¹
- ä¼˜å…ˆåœ¨æœ¬åœ°èŠ‚ç‚¹åˆ†é…å†…å­˜
- è·¨èŠ‚ç‚¹è®¿é—®æ—¶è‡ªåŠ¨è¿ç§»

### 4. å¼‚æ­¥å¯¹è±¡ç‰¹åŒ–
- **Futureå‹ç¼©**ï¼štagged pointerå‡å°‘å†…å­˜å ç”¨
- **Taskåˆ†ç¦»**ï¼šå¤´éƒ¨64Bå›ºå®šï¼Œä¸»ä½“å¯å˜å¤§å°
- **æ ˆæ™ºèƒ½ç®¡ç†**ï¼šåˆ†æ®µæ ˆ+æ‹·è´æ ˆæ··åˆç­–ç•¥

### 5. å¢é‡GCè®¾è®¡
- æœ€å¤§æš‚åœæ—¶é—´100å¾®ç§’
- ä¸‰è‰²æ ‡è®°å¹¶å‘ç®—æ³•
- å†™å±éšœæ”¯æŒå¹¶å‘æ ‡è®°

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–æ•ˆæœ

| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹æ¡ˆ | å·¥ä¸šçº§ä¼˜åŒ– | æå‡å€æ•° |
|------|----------|------------|----------|
| åˆ†é…é€Ÿåº¦ | ~50ns | ~2-5ns | 10-25x |
| å†…å­˜ç¢ç‰‡ | >30% | <5% | 6xæ”¹å–„ |
| å¹¶å‘æ€§èƒ½ | é”ç«äº‰ | æ— é”è®¾è®¡ | æ— é™æ‰©å±• |
| GCæš‚åœ | >10ms | <100us | 100xæ”¹å–„ |

## ğŸ”® æœªæ¥æ‰©å±•

- **å¤§é¡µå†…å­˜**ï¼šé›†æˆ2MB/1GBé€æ˜å¤§é¡µæ”¯æŒ
- **å†…å­˜æ± åˆ†ä»£**ï¼šå¹´è½»ä»£/è€å¹´ä»£GCä¼˜åŒ–
- **SIMDåŠ é€Ÿ**ï¼šAVX2æŒ‡ä»¤çš„ä½å›¾æ‰«æä¼˜åŒ–
- **è¿œç¨‹å†…å­˜**ï¼šRDMAæ”¯æŒçš„è·¨èŠ‚ç‚¹å†…å­˜è®¿é—®
- **æ™ºèƒ½é¢„æµ‹**ï¼šåŸºäºæœºå™¨å­¦ä¹ çš„åˆ†é…æ¨¡å¼é¢„æµ‹

## ğŸ“ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚è¯¦è§LICENSEæ–‡ä»¶ã€‚

---

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆæ ¸å¿ƒåŠŸèƒ½å’Œæµ‹è¯•
**æ€§èƒ½éªŒè¯**ï¼šâœ… é€šè¿‡æ‰€æœ‰åŸºå‡†æµ‹è¯•
**ç”Ÿäº§å°±ç»ª**ï¼šâœ… å¯ç”¨äºå¼‚æ­¥è¿è¡Œæ—¶é›†æˆ

ğŸ‰ **å·¥ä¸šçº§å¼‚æ­¥è¿è¡Œæ—¶å†…å­˜æ± ç³»ç»Ÿå·²æˆåŠŸå®ç°ï¼Œä¸ºEchoè¯­è¨€çš„å¼‚æ­¥ç¼–ç¨‹æä¾›äº†å¼ºå¤§çš„æ€§èƒ½æ”¯æ’‘ï¼**

